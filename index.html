<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova AI: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables */
        :root {
            --background-color: #0d0c0f;
            --surface-color: #1a1a1d;
            --primary-color: #c724b1;
            --primary-gradient: linear-gradient(to right, #e024a2 0%, #8b34ea 100%);
            --secondary-color: #4ac9ff;
            --accent-color: #4ac9ff;
            --text-primary-color: #f0f0f0;
            --text-secondary-color: #a0a0a0;
            --border-color: #333;
            --error-color: #ff4757;
            --success-color: #2ed573;
            --font-family: 'Kanit', sans-serif;
        }

        /* General Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--surface-color);
        }

        /* For Webkit browsers */
        *::-webkit-scrollbar {
            width: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        *::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
            border: 2px solid var(--surface-color);
        }

        html,
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-primary-color);
            line-height: 1.6;
            height: 100%;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        button, input, select, textarea {
            font-family: var(--font-family);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #252528;
            color: var(--text-primary-color);
            padding: 0.75rem 1rem;
        }
        
        button {
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: scale(0.98) translateY(0);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            transform: none;
        }
        
        /* Header */
        .header {
            background-color: var(--surface-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-secondary-color);
            font-size: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon svg {
            width: 40px;
            height: 40px;
            color: var(--primary-color);
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--text-primary-color);
        }

        .logo-text p {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
            margin: 0;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-profile {
            display: none; /* Hidden by default */
            align-items: center;
            gap: 0.75rem;
        }
        
        #user-greeting {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
        }

        .logout-btn {
            background-color: #444;
            color: var(--text-secondary-color);
            padding: 0.5rem 1rem;
        }
        .logout-btn:hover {
             background-color: var(--error-color);
             color: white;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            background-color: var(--background-color);
            padding: 0.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .mode-btn {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            background-color: #252528;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .mode-btn svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
            flex-shrink: 0;
        }

        .mode-btn.active {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
            border: none;
        }

        .mode-btn.active svg {
            opacity: 1;
            color: white;
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-grow: 1;
            gap: 1rem;
            overflow: hidden;
            position: relative;
        }
        
        .side-panel {
            width: 35%;
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 12px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
        }

        .side-panel h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .tip-card {
            background-color: #252528;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid var(--accent-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .tip-card h4 {
            margin-bottom: 0.5rem;
            color: var(--accent-color);
        }

        .tip-card p {
            font-size: 0.9rem;
            color: var(--text-secondary-color);
        }
        
        /* Chat Panel */
        .chat-panel {
            width: 65%;
            display: flex;
            flex-direction: column;
            background-color: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-messages {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .message {
            display: flex;
            margin-bottom: 1.5rem;
            max-width: 90%;
        }

        .message-avatar {
            font-size: 1.5rem;
            margin-right: 1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--background-color);
            flex-shrink: 0;
            overflow: hidden; /* For image */
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .message-content {
            background-color: #2a2a2a;
            padding: 1rem;
            border-radius: 12px;
            flex-grow: 1;
            word-wrap: break-word;
            position: relative;
        }
        
        .message-content h3 { margin-top: 1rem; color: var(--secondary-color); }
        .message-content strong { color: var(--primary-color); }
        .message-content br { content: ""; display: block; margin-bottom: 0.5em; }


        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message.user .message-avatar {
            margin-left: 1rem;
            margin-right: 0;
        }

        .message.user .message-content {
            background-color: var(--primary-variant-color);
        }

        .message-content pre {
            background-color: #111;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.75rem;
        }

        .action-btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            background-color: #3a3a3a;
        }
        
        .generated-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
        }

        .image-loading-placeholder {
             background-color: #2a2a2a;
             border-radius: 8px;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             padding: 2rem;
             margin-top: 1rem;
             border: 1px dashed var(--border-color);
        }
        
        .image-loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }


        .message.loading .message-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background-color: var(--text-secondary-color);
            border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Chat Input */
        .chat-input-area {
            padding: 1rem;
            background-color: var(--background-color);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 0.5rem;
        }
        
        .message-input {
            flex-grow: 1;
            resize: none;
        }
        
        .send-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-gradient);
            background-size: 200% auto;
            color: white;
            font-weight: 600;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .send-btn:hover {
            background-position: right center;
        }
        .send-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            padding-top: 0.5rem;
            color: var(--text-secondary-color);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #444;
        }

        .status-dot.active {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 213, 115, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0); }
        }
        
        .backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container { padding: 0; }
            .header, .status-bar { 
                border-radius: 0; 
                padding-left: 1rem;
                padding-right: 1rem;
            }
             .main-content {
                flex-grow: 1;
                height: calc(100vh - 150px); /* Adjust based on header+footer height */
            }
            .chat-panel {
                width: 100%;
                border-radius: 0;
            }
            .side-panel {
                position: fixed;
                left: 0;
                top: 0;
                width: 80%;
                max-width: 320px;
                height: 100%;
                z-index: 1001;
                transform: translateX(-100%);
                border-radius: 0;
                box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            }
            .side-panel.show {
                transform: translateX(0);
            }
            .backdrop.show {
                display: block;
            }

            .mobile-menu-btn {
                display: block;
            }
            .mode-selector {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 1rem;
                scrollbar-width: none;
            }
            .mode-selector::-webkit-scrollbar {
                display: none;
            }
            .mode-selector .mode-btn {
                flex: 0 0 auto;
            }
        }
        
        @media (max-width: 768px) {
            .logo-text h1 { font-size: 1.2rem; }
            .logo-text p { display: none; }
            #user-greeting { display: none; }
            .mode-btn { font-size: 0.8rem; padding: 0.5rem 0.75rem; }
            .main-content {
                height: calc(100vh - 140px);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 2rem;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            position: relative;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        #loginModal .modal-content {
            max-width: 400px;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            text-align: center;
        }
        
        #loginModal a {
            color: var(--secondary-color);
            cursor: pointer;
        }
        
        .form-group {
            flex-grow: 1;
            min-width: 200px;
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary-color);
        }

        /* Full screen loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            flex-direction: column;
            gap: 1rem;
        }

        /* Character Image Upload */
        .char-image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #2a2a2a;
            border: 2px dashed var(--border-color);
            margin: 0 auto 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary-color);
            overflow: hidden;
        }
        .char-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Gallery Styles */
        #gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .gallery-item {
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative;
        }
        .gallery-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(187, 134, 252, 0.5);
        }
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #image-viewer-modal {
            align-items: center;
            justify-content: center;
        }

        #image-viewer-modal .modal-content {
            background: transparent;
            border: none;
            width: 90vw;
            height: 90vh;
            padding: 0;
            max-width: 1200px;
        }

        .image-viewer-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .image-viewer-container img {
            flex-grow: 1;
            object-fit: contain;
            width: 100%;
            height: 80%; /* Adjust as needed */
            border-radius: 8px;
        }

        .image-viewer-prompt {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
            max-height: 20%;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- App container -->
    <div class="container" id="app-container" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="header-left">
                    <button id="mobile-menu-btn" class="mobile-menu-btn">‚ò∞</button>
                    <div class="logo">
                        <div class="logo-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                        </div>
                        <div class="logo-text">
                            <h1>Nova AI</h1>
                            <p>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
                        </div>
                    </div>
                </div>
                <div class="auth-section">
                    <div class="user-profile" id="user-profile">
                        <span id="user-greeting"></span>
                        <button class="logout-btn" id="logout-btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </div>
            </div>

            <!-- Mode Selector -->
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="general-chat"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                <button class="mode-btn" data-mode="promptmaster"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>Prompt Master</button>
                <button class="mode-btn" data-mode="novel-writer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</button>
                <button class="mode-btn" data-mode="char-chat"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
                <button class="mode-btn" data-mode="storyboard"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>Storyboard</button>
                <button class="mode-btn" data-mode="image"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>Image Prompt</button>
                <button class="mode-btn" data-mode="gallery"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><path d="M21 15l-5-5L5 21"></path></svg>My Gallery</button>
                <button class="mode-btn" data-mode="analyzer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>Prompt Analyzer</button>
                <button class="mode-btn" data-mode="character"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
                <button class="mode-btn" data-mode="library"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
                <button class="mode-btn" data-mode="favorites"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>Prompt ‡πÇ‡∏õ‡∏£‡∏î</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
             <div id="backdrop" class="backdrop"></div>
            <!-- Left Side Panel (Info, Libraries, etc.) -->
            <div class="side-panel" id="sidePanelContainer">
                <!-- Content will be injected by JS -->
            </div>
            
            <!-- Chat Panel -->
            <div class="chat-panel">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be rendered here -->
                </div>
                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <button id="ideaBtn" class="idea-btn" title="‚ú® ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢">üí°</button>
                        <textarea id="messageInput" class="message-input" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£..." rows="1"></textarea>
                        <button id="sendButton" class="send-btn">
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-bar">
             <div class="status-indicator">
                <span id="status-dot" class="status-dot"></span>
                <span id="status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
            </div>
            <button id="clearHistoryBtn" style="font-size: 0.8rem; padding: 0.25rem 0.5rem; background: #555;">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>
    </div>
    
    <!-- Login Modal -->
     <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 id="form-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div id="auth-error" style="color: var(--error-color); margin-bottom: 1rem; text-align: center; display: none;"></div>
            <div class="form-group">
                <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                <input type="email" id="email" class="template-input" required>
            </div>
            <div class="form-group">
                <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" id="password" class="template-input" required>
            </div>
            <button id="submit-btn" style="width: 100%; padding: 0.75rem; background: var(--primary-gradient); color: white; font-weight: 600; border: none;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary-color);">
                <span id="prompt-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?</span>
                <a href="#" id="toggle-form-link">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
            </p>
        </div>
    </div>
    
    <!-- Loader -->
    <div id="loader">
        <div class="image-loading-spinner"></div>
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
    </div>

    <!-- Modals -->
    <div id="characterCreatorModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>üßô ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h2>
            <div id="characterFormContainer" style="overflow-y: auto; padding-right: 1rem;">
                <div class="form-section">
                     <div class="char-image-preview" id="charImagePreview">
                         <span>+ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ</span>
                         <img id="charImagePreviewImg" src="" alt="Preview" style="display: none;">
                     </div>
                     <input type="file" id="charImageUpload" accept="image/*" style="display: none;">
                     <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å/‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó*</label>
                        <input type="text" id="charNickname" class="template-input" placeholder='‡πÄ‡∏ä‡πà‡∏ô "CEO ‡∏™‡∏≤‡∏ß", "‡∏ô‡∏±‡∏Å‡∏™‡∏∑‡∏ö‡∏û‡πÄ‡∏ô‡∏à‡∏£"'>
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å*</label>
                        <textarea id="charAppearance" class="template-textarea" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ç‡∏¥‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏≤‡∏¢‡∏∏ 25 ‡∏õ‡∏µ, ‡∏ú‡∏°‡∏™‡∏µ‡∏î‡∏≥‡∏¢‡∏≤‡∏ß, ‡∏ï‡∏≤‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•, ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô, ‡∏™‡∏ß‡∏°‡∏ä‡∏∏‡∏î‡∏™‡∏π‡∏ó‡∏™‡∏µ‡πÄ‡∏ó‡∏≤"></textarea>
                    </div>
                     <div class="form-group">
                        <label>‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏ô‡∏¥‡∏™‡∏±‡∏¢</label>
                        <textarea id="charPersonality" class="template-textarea" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à, ‡∏â‡∏•‡∏≤‡∏î, ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô, ‡∏û‡∏π‡∏î‡∏à‡∏≤‡∏â‡∏∞‡∏â‡∏≤‡∏ô"></textarea>
                    </div>
                </div>
                <button id="saveCharacterBtn" style="width: 100%; padding: 0.75rem; background: var(--primary-gradient); color: white; font-weight: 600; border: none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
            </div>
        </div>
    </div>

    <div id="image-viewer-modal" class="modal">
        <span class="close-btn" style="color: white; font-size: 40px;">&times;</span>
        <div class="image-viewer-container">
            <img id="viewer-image" src="" alt="Full size image">
            <div id="viewer-prompt" class="image-viewer-prompt"></div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const loader = document.getElementById('loader');
            const loginModal = document.getElementById('loginModal');
            const appContainer = document.getElementById('app-container');
            const userProfile = document.getElementById('user-profile');
            const userGreeting = document.getElementById('user-greeting');
            const logoutBtn = document.getElementById('logout-btn');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const backdrop = document.getElementById('backdrop');

            // Login Form elements
            const loginForm = {
                title: document.getElementById('form-title'),
                emailInput: document.getElementById('email'),
                passwordInput: document.getElementById('password'),
                submitBtn: document.getElementById('submit-btn'),
                toggleLink: document.getElementById('toggle-form-link'),
                promptText: document.getElementById('prompt-text'),
                errorDiv: document.getElementById('auth-error')
            };
            let isLoginMode = true;

            const modeButtons = document.querySelectorAll('.mode-btn');
            const sidePanelContainer = document.getElementById('sidePanelContainer');
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const ideaBtn = document.getElementById('ideaBtn');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            let currentMode = 'general-chat';
            let chatHistory = {};
            let isLoading = false;
            let activeCharacterForChat = null;
            let selectedCharImageFile = null;
            let editingCharacterId = null;
            
            // --- Firebase Variables ---
            let db, auth, storage, userId;
            let unsubscribeChatHistory;

            // --- Firebase Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyCnQevJTgS4Hk-sr8EiK3fOLPxmrKT5F90",
                authDomain: "chatbot-2086b.firebaseapp.com",
                projectId: "chatbot-2086b",
                storageBucket: "chatbot-2086b.appspot.com",
                messagingSenderId: "102147147231",
                appId: "1:102147147231:web:3e06c1f6945913c7dbb06a",
                measurementId: "G-8777KRHH1Q"
            };


            // --- Gemini API Configuration ---
            const API_KEY = "AIzaSyCu3l1SyGm_gIc8i96Kw2RfawVU4DFxB3A";
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
            
            // --- Firebase Initialization and Auth ---
            function initializeFirebase() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    storage = firebase.storage();

                    auth.onAuthStateChanged(user => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase Auth: Signed in with UID:", userId);
                            
                            loginModal.classList.remove('show');
                            loader.style.display = 'none';
                            appContainer.style.display = 'flex';
                            userProfile.style.display = 'flex';
                            
                            const userName = user.email.split('@')[0];
                            const capitalizedUserName = userName.charAt(0).toUpperCase() + userName.slice(1);
                            userGreeting.textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ${capitalizedUserName}`;


                            setupAllListeners();
                        } else {
                            loader.style.display = 'none';
                            appContainer.style.display = 'none';
                            userProfile.style.display = 'none';
                            loginModal.classList.add('show');
                        }
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    loader.innerHTML = `<p>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô: ${error.message}</p>`;
                }
            }

            // --- Real-time Data Listeners ---
            function setupAllListeners() {
                if (!userId) return;
                if (unsubscribeChatHistory) unsubscribeChatHistory();

                const userDocRef = db.collection("users").doc(userId);
                unsubscribeChatHistory = userDocRef.onSnapshot((doc) => {
                    chatHistory = doc.exists && doc.data().chatHistory ? doc.data().chatHistory : {};
                    console.log("Chat history synced from Firestore.");
                    renderChatHistory(); 
                });
            }

            // --- Content and Prompts ---
            const panelContent = {
                'general-chat': `<h3>üí¨ ‡∏Ñ‡∏∏‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h3><div class="tip-card"><h4>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå</h4><p>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡∏£‡∏∞‡∏î‡∏°‡∏™‡∏°‡∏≠‡∏á, ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏µ‡∏ü‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ</p></div>`,
                promptmaster: `<h3>üé• Prompt Master</h3><div class="tip-card"><h4>‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</h4><p>‡πÅ‡∏Ñ‡πà‡∏ö‡∏≠‡∏Å‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡πâ‡∏ß Gemini ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Prompt ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏∏‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ</p></div>`,
                scenepro: `
                    <h3>üé¨ Scene Pro Template</h3>
                    <div class="tip-card">
                        <h4>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤</h4>
                        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="productName" class="template-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≥‡∏´‡∏≠‡∏° 'Midnight Bloom'"></div>
                        <div class="form-group"><label>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡πà‡∏ô</label><textarea id="productFeatures" class="template-textarea" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏°‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö, ‡∏ï‡∏¥‡∏î‡∏ó‡∏ô‡∏ô‡∏≤‡∏ô"></textarea></div>
                        <div class="form-group"><label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><input type="text" id="targetAudience" class="template-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô"></div>
                        <div class="form-group"><label>‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå/‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏õ‡∏ï‡πå</label><input type="text" id="moodConcept" class="template-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö, ‡∏ô‡πà‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤, ‡∏™‡∏á‡πà‡∏≤‡∏á‡∏≤‡∏°"></div>
                        <button id="generateFromTemplateBtn" style="width:100%; padding: 0.75rem; margin-top: 1rem; background-color: var(--secondary-color); color:black; font-weight: 600;">‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏à‡∏≤‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï ‚ú®</button>
                    </div>`,
                storyboard: `<h3>üìú Storyboard Mode</h3><div class="tip-card"><h4>‡∏™‡∏£‡πâ‡∏≤‡∏á Storyboard ‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠</h4><p>‡πÉ‡∏™‡πà‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡πâ‡∏ß Gemini ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏â‡∏≤‡∏Å (Scene) 3-5 ‡∏â‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p></div>`,
                image: `
                    <h3>üñºÔ∏è Image Prompt Creator</h3><div class="tip-card"><h4>‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h4><p>‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡πâ‡∏ß Gemini ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p></div>
                    <div class="tip-card"><h4>üö´ Negative Prompt (‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)</h4><div class="form-group"><textarea id="negativePromptInput" class="template-textarea" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô text, watermark, ugly, deformed..."></textarea></div></div>`,
                analyzer: `<h3>üßê Prompt Analyzer</h3><div class="tip-card"><h4>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Prompt</h4><p>‡∏ß‡∏≤‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß Gemini ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á ‡∏à‡∏∏‡∏î‡∏≠‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô</p></div>`,
                character: `<h3>üßô ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3><div class="tip-card"><h4>‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</h4><p>‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p></div><button id="newCharacterBtn" style="width:100%; padding: 0.75rem; margin-top: 1rem; background-color: var(--primary-color); color:black; font-weight: 600;">+ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>`,
                library: `<h3>üóÇÔ∏è ‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3><p style="color:var(--text-secondary-color); font-size: 0.9rem; margin-bottom: 1rem;">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p><div id="characterList"></div>`,
                favorites: `<h3>‚≠ê Prompt ‡πÇ‡∏õ‡∏£‡∏î</h3><p style="color:var(--text-secondary-color); font-size: 0.9rem; margin-bottom: 1rem;">Prompt ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p><div id="favoritesList"></div>`,
                gallery: `<h3>üé® My Gallery</h3><p style="color:var(--text-secondary-color); font-size: 0.9rem; margin-bottom: 1rem;">‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p><div id="gallery-grid"></div>`,
                'char-chat': `<h3>üí¨ ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h3><div id="charChatPanel"></div>`,
                'novel-writer': `
                    <h3>üìñ ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h3>
                    <div class="tip-card">
                        <h4>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
                        <div class="form-group">
                            <label>‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Genre)</label>
                            <input type="text" id="novelGenre" class="template-input" list="genres" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ, ‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô, ‡∏£‡∏±‡∏Å‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å">
                            <datalist id="genres"><option value="‡πÅ‡∏ü‡∏ô‡∏ï‡∏≤‡∏ã‡∏µ"><option value="‡πÑ‡∏ã‡πÑ‡∏ü"><option value="‡∏™‡∏∑‡∏ö‡∏™‡∏ß‡∏ô‡∏™‡∏≠‡∏ö‡∏™‡∏ß‡∏ô"><option value="‡∏£‡∏±‡∏Å‡πÇ‡∏£‡πÅ‡∏°‡∏ô‡∏ï‡∏¥‡∏Å"><option value="‡∏™‡∏¢‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç"></datalist>
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <select id="novelCharacterSelect" class="template-select"><option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option></select>
                        </div>
                        <div class="form-group">
                            <label>‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢/‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                            <textarea id="novelPlot" class="template-textarea" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≤‡∏¢‡∏´‡∏ô‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏ô‡πÇ‡∏•‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏û‡∏Å‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤..."></textarea>
                        </div>
                        <button id="generateNovelBtn" style="width:100%; padding: 0.75rem; margin-top: 1rem; background-color: var(--secondary-color); color:black; font-weight: 600;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‚ú®</button>
                    </div>`,
            };
           
           const systemPrompts = {
                'general-chat': "You are Nova AI, a helpful and creative assistant. Engage in a friendly conversation with the user in Thai. You can help brainstorm ideas, answer questions, and assist with various creative tasks. Maintain a conversational and encouraging tone.",
                promptmaster: "You are an expert prompt engineer for text-to-video AI. Your task is to take a user's idea (which may be a follow-up to a previous prompt) and generate a single, detailed, professional, cinematic prompt IN ENGLISH. Incorporate previous context if the user is refining the prompt. The prompt must include details about cinematography, camera angles, lighting, mood, and visual style. Do not ask questions, just provide the final prompt.",
                scenepro: "You are a creative director for product commercials. Convert the user's request into a compelling, short video prompt IN ENGLISH. Focus on visual storytelling, camera work, and appealing aesthetics. If the user provides feedback, refine the previous prompt. Provide only the final prompt.",
                storyboard: "You are an expert scriptwriter and storyboard artist. Your task is to take a user's short story, plot, or idea and break it down into 3-5 distinct scenes suitable for a short video. For each scene, create a detailed text-to-video prompt IN ENGLISH. The output should be in THAI, clearly structured using Markdown with headings for each scene (e.g., '### ‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà 1: ...'). Each prompt must be inside a separate code block and include cinematic details like camera shots, angles, lighting, and character actions. Start directly with the first scene.",
                image: "You are an expert prompt creator for image generation AI. Transform the user's idea into a highly detailed and effective prompt IN ENGLISH. The prompt should be a comma-separated list of keywords. If the user provides feedback, refine the previous prompt. Provide only the final prompt.",
                analyzer: "You are a world-class prompt engineering analyst. Your task is to analyze the user's provided prompt. Provide a structured analysis in THAI with the following sections using markdown: '**‡∏à‡∏∏‡∏î‡πÅ‡∏Ç‡πá‡∏á (Strengths):**', '**‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (Suggestions for Improvement):**', and '**Prompt ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß (Improved Prompt):**'. Be constructive and clear.",
                character: "You are a creative writer. Based on the user's input, generate a detailed character profile in THAI, clearly structured with '**‡∏ä‡∏∑‡πà‡∏≠/‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:**', '**‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å:**' and '**‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å:**' sections. Make the descriptions vivid and ready to be saved.",
                'novel-writer': "You are a professional novel writer. Your task is to write a compelling short story (around 300-500 words) in Thai. The user will provide the genre, protagonist details (if any), and a starting plot. Write in an engaging, narrative style, using rich descriptions and dialogue. If the user says '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡πà‡∏≠' or similar, continue the story logically from where it left off.",
            };


            // --- API Call Functions ---
            async function callApi(url, payload) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status} ${response.statusText}`);
                    return await response.json();
                } catch (error) { 
                    console.error("API call failed:", error); 
                    return { error: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI" }; 
                }
            }
            
            async function callGeminiAPI(history, systemInstruction) {
                setLoading(true);
                const payload = { contents: history, systemInstruction: { parts: [{ text: systemInstruction }] } };
                const result = await callApi(GEMINI_API_URL, payload);
                setLoading(false);
                if (result.error) return result.error;
                const candidate = result.candidates?.[0];
                return (candidate && candidate.content?.parts?.[0]?.text) ? candidate.content.parts[0].text : "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å AI";
            }
            
            async function callImagenAPI(prompt, messageDiv) {
                const placeholder = messageDiv.querySelector('.image-loading-placeholder');
                if(placeholder) placeholder.style.display = 'flex';
                const payload = { instances: [{ prompt }], parameters: { "sampleCount": 1 } };
                const result = await callApi(IMAGEN_API_URL, payload);
                if (placeholder) placeholder.remove();
                if (result.error || !result.predictions?.[0]?.bytesBase64Encoded) {
                    messageDiv.innerHTML += `<p style="color:var(--error-color)">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>`;
                    return;
                }
                const base64Data = result.predictions[0].bytesBase64Encoded;
                const imageUrl = `data:image/png;base64,${base64Data}`;
                const img = document.createElement('img');
                img.src = imageUrl; img.className = 'generated-image'; img.alt = prompt;
                messageDiv.appendChild(img);

                const actions = messageDiv.querySelector('.message-actions');
                if(actions) {
                    const saveBtn = document.createElement('button');
                    saveBtn.className = 'action-btn save-image-btn';
                    saveBtn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                    actions.appendChild(saveBtn);

                    saveBtn.addEventListener('click', async () => {
                         saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                         saveBtn.disabled = true;
                         await saveImageToGallery(imageUrl, prompt);
                         saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                    });
                }
            }
            
            // --- UI & State Management ---
            function setLoading(state) {
                isLoading = state;
                [sendButton, ideaBtn, messageInput].forEach(el => el.disabled = state);
                statusText.textContent = state ? 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...' : '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                statusDot.classList.toggle('active', !state);
            }
            
            function switchMode(newMode) {
                currentMode = newMode;
                activeCharacterForChat = null;
                updateUIForMode();
                renderChatHistory();
            }

            function updateUIForMode() {
                modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
                
                sidePanelContainer.innerHTML = panelContent[currentMode];
                
                const newCharBtn = document.getElementById('newCharacterBtn');
                if (newCharBtn) newCharBtn.addEventListener('click', () => openCharacterModal());

                const templateBtn = document.getElementById('generateFromTemplateBtn');
                if (templateBtn) templateBtn.addEventListener('click', generateFromTemplate);
                
                const novelBtn = document.getElementById('generateNovelBtn');
                if (novelBtn) {
                    populateCharacterDropdown();
                    novelBtn.addEventListener('click', startNovelGeneration);
                }

                if (currentMode === 'library') loadCharacters();
                if (currentMode === 'favorites') loadFavorites();
                if (currentMode === 'char-chat') renderCharChatPanel();
                if (currentMode === 'gallery') loadGallery();
                
                const placeholders = {
                    'general-chat': '‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...',
                    promptmaster: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏≤‡∏Å‡πÑ‡∏•‡πà‡∏•‡πà‡∏≤‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô...",
                    scenepro: "‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt...",
                    storyboard: "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠: ‡∏ô‡∏±‡∏Å‡∏ö‡∏¥‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏®‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏ß‡∏á‡πÉ‡∏´‡∏°‡πà...",
                    image: "‡πÅ‡∏°‡∏ß‡πÉ‡∏™‡πà‡πÅ‡∏ß‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÅ‡∏î‡∏î‡∏ö‡∏ô‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î...",
                    analyzer: "‡∏ß‡∏≤‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...",
                    character: "‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô '‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡∏´‡∏ç‡∏¥‡∏á‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô'...",
                    'char-chat': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢...',
                    'novel-writer': '‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß...',
                    library: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                    favorites: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Prompt ‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                    gallery: "‡∏Ñ‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
                };
                messageInput.placeholder = placeholders[currentMode] || "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...";
                messageInput.disabled = ['scenepro', 'library', 'favorites', 'gallery'].includes(currentMode) || (currentMode === 'char-chat' && !activeCharacterForChat);
            }

            function markdownToHtml(text) {
                let html = text
                    .replace(/### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                    .replace(/```([\s\S]*?)```/gim, (match, p1) => `<pre><code>${p1.trim()}</code></pre>`)
                    .replace(/\n/g, '<br>');
                return html;
            }
            
            async function sendMessage() {
                const userInput = messageInput.value.trim();
                if (!userInput || isLoading) return;
                addToHistoryAndRender(userInput, 'user');
                messageInput.value = '';
                const loadingMessage = renderMessage(" ", 'loading');
                
                const historyKey = (currentMode === 'char-chat' && activeCharacterForChat) ? `char-chat-${activeCharacterForChat.id}` : currentMode;
                const historyForAPI = chatHistory[historyKey] || [];

                let systemInstruction = systemPrompts[currentMode];
                if (currentMode === 'char-chat' && activeCharacterForChat) {
                    systemInstruction = `You must act as the character '${activeCharacterForChat.nickname}'. Personality: '${activeCharacterForChat.personality}'. Appearance: '${activeCharacterForChat.appearance}'. Respond in character at all times, in Thai.`;
                }
                const aiResponse = await callGeminiAPI(historyForAPI, systemInstruction);
                loadingMessage.remove();
                addToHistoryAndRender(aiResponse, 'assistant');
            }

            async function suggestIdea() {
                if (isLoading || messageInput.disabled) return;
                const systemInstruction = "You are a creative idea generator. Provide a single, concise, and inspiring idea in Thai based on the user's selected mode. Do not add any extra text or explanation.";
                setLoading(true);
                const idea = await callGeminiAPI([{ role: 'user', parts: [{ text: "Suggest an idea" }] }], systemInstruction);
                setLoading(false);
                if (idea && !idea.includes("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢")) {
                    messageInput.value = idea;
                    messageInput.focus();
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");
                }
            }
            
            async function startNovelGeneration() {
                const genre = document.getElementById('novelGenre').value.trim();
                const plot = document.getElementById('novelPlot').value.trim();
                const charSelect = document.getElementById('novelCharacterSelect');
                const charId = charSelect.value;
                if (!genre || !plot) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢/‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"');
                    return;
                }
                let userInput = `‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${genre}\n‡∏û‡∏•‡πá‡∏≠‡∏ï: ${plot}`;
                if (charId) {
                    const doc = await db.collection("users").doc(userId).collection("characters").doc(charId).get();
                    if(doc.exists) {
                        const characterData = doc.data();
                        userInput += `\n‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏≠‡∏Å: ${characterData.nickname} (‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞: ${characterData.appearance}, ‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ${characterData.personality})`;
                    }
                }
                messageInput.value = userInput;
                sendMessage();
            }

            async function renderCharChatPanel() {
                const panel = document.getElementById('charChatPanel');
                if (!panel) return;

                if (activeCharacterForChat) {
                    const imageUrl = activeCharacterForChat.imageUrl || 'https://placehold.co/100x100/1e1e1e/a0a0a0?text=üé≠';
                    panel.innerHTML = `
                        <div class="tip-card">
                            <h4>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö:</h4>
                            <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
                               <img src="${imageUrl}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                               <p style="color: var(--secondary-color); font-size: 1.2rem; font-weight: bold;">${activeCharacterForChat.nickname}</p>
                            </div>
                            <button id="endChatBtn" style="width:100%; padding: 0.5rem; margin-top: 1rem; background-color: var(--error-color);">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
                        </div>`;
                    document.getElementById('endChatBtn').addEventListener('click', endCharacterChat);
                } else {
                    const charactersCollection = db.collection("users").doc(userId).collection("characters");
                    const charactersSnapshot = await charactersCollection.get();
                    const characters = charactersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    if (characters.length === 0) {
                        panel.innerHTML = `<div class="tip-card"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏°‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô</p></div>`;
                        return;
                    }
                    let charListHtml = '<h4>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢:</h4>';
                    characters.forEach(char => {
                        const imageUrl = char.imageUrl || 'https://placehold.co/100x100/2a2a2a/a0a0a0?text=üé≠';
                        charListHtml += `
                            <div class="tip-card" style="display:flex; align-items:center; gap:1rem;">
                                <img src="${imageUrl}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                                <div style="flex-grow:1;">
                                    <h5>${char.nickname}</h5>
                                    <button class="start-chat-btn" data-id="${char.id}" style="width:100%;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢</button>
                                </div>
                            </div>`;
                    });
                    panel.innerHTML = charListHtml;
                    panel.querySelectorAll('.start-chat-btn').forEach(btn => {
                        btn.addEventListener('click', () => startCharacterChat(btn.dataset.id));
                    });
                }
            }

            async function startCharacterChat(charId) {
                const doc = await db.collection("users").doc(userId).collection("characters").doc(charId).get();
                if (doc.exists) {
                     activeCharacterForChat = { id: doc.id, ...doc.data() };
                }

                if(activeCharacterForChat) {
                    renderCharChatPanel();
                    messageInput.disabled = false;
                    messageInput.placeholder = `‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö ${activeCharacterForChat.nickname}...`;
                    messageInput.focus();
                    renderChatHistory(); // Load specific chat history for this character
                }
            }

            function endCharacterChat() {
                activeCharacterForChat = null;
                renderCharChatPanel();
                messageInput.disabled = true;
                messageInput.placeholder = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢...';
            }
            
            async function generateFromTemplate() {
                 const productName = document.getElementById('productName').value;
                const productFeatures = document.getElementById('productFeatures').value;
                const targetAudience = document.getElementById('targetAudience').value;
                const moodConcept = document.getElementById('moodConcept').value;

                if(!productName || !productFeatures || !moodConcept) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏î‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏õ‡∏ï‡πå');
                    return;
                }

                const userInput = `‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:
                - ‡∏ä‡∏∑‡πà‡∏≠: ${productName}
                - ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥: ${productFeatures}
                - ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${targetAudience}
                - ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå/‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡πá‡∏õ‡∏ï‡πå: ${moodConcept}`;

                addToHistoryAndRender(userInput, 'user');
                const loadingMessage = renderMessage(" ", 'loading');
                const aiResponse = await callGeminiAPI([{ role: 'user', parts: [{text: userInput}] }], systemPrompts.scenepro);
                loadingMessage.remove();
                addToHistoryAndRender(aiResponse, 'assistant');
            }

             function renderMessage(text, type, id) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.dataset.id = id;
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';

                let avatarContent = 'ü§ñ';
                if (type === 'user') {
                    avatarContent = 'üë§';
                } else if (currentMode === 'char-chat' && activeCharacterForChat) {
                    const imageUrl = activeCharacterForChat.imageUrl;
                    if(imageUrl) {
                        avatarContent = `<img src="${imageUrl}" alt="${activeCharacterForChat.nickname}">`;
                    } else {
                        avatarContent = 'üé≠';
                    }
                }
                avatar.innerHTML = avatarContent;

                const content = document.createElement('div');
                content.className = 'message-content';

                if (type === 'loading') {
                    content.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...`;
                } else if (type === 'assistant') {
                    let promptTextForActions = text;
                    if (['analyzer', 'storyboard', 'novel-writer', 'character'].includes(currentMode)) {
                        content.innerHTML = markdownToHtml(text);
                        const codeBlocks = text.match(/```([\s\S]*?)```/gim);
                        if (codeBlocks) promptTextForActions = codeBlocks.map(block => block.replace(/```/g, '')).join('\n\n---\n\n');
                    } else {
                        if (currentMode === 'char-chat' || currentMode === 'general-chat') {
                             content.innerHTML = text.replace(/\n/g, '<br>');
                        } else {
                            content.innerHTML = `<pre><code>${text}</code></pre>`;
                        }
                    }

                    const actions = document.createElement('div');
                    actions.className = 'message-actions';
                    actions.innerHTML = `
                        <button class="action-btn copy-btn" data-prompt="${encodeURIComponent(promptTextForActions)}">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                        <button class="action-btn favorite-btn" data-prompt="${encodeURIComponent(promptTextForActions)}">‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    `;
                    if (currentMode === 'image') {
                        actions.innerHTML += `<button class="action-btn generate-image-btn" data-prompt="${encodeURIComponent(promptTextForActions)}">üé® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û</button>`;
                    }
                    content.appendChild(actions);

                } else {
                    content.textContent = text;
                }
                
                messageDiv.appendChild(avatar); messageDiv.appendChild(content);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return messageDiv;
            }

            function addToHistoryAndRender(text, role) {
                const historyKey = (currentMode === 'char-chat' && activeCharacterForChat) ? `char-chat-${activeCharacterForChat.id}` : currentMode;
                const message = { role, parts: [{ text }], id: Date.now() };
                if (!chatHistory[historyKey]) chatHistory[historyKey] = [];
                if(role === 'user' || role === 'assistant') {
                    chatHistory[historyKey].push({role: role === 'user' ? 'user' : 'model', parts: message.parts});
                }
                saveChatHistory();
                renderMessage(text, role, message.id);
            }

            async function saveChatHistory() {
                if (!userId) return;
                try {
                    const mainDocRef = db.collection("users").doc(userId);
                    await mainDocRef.set({ chatHistory: chatHistory }, { merge: true });
                    console.log("Chat history saved to Firestore.");
                } catch (error) {
                    console.error("Error saving chat history to Firestore:", error);
                }
            }

            function renderChatHistory() {
                const historyKey = (currentMode === 'char-chat' && activeCharacterForChat) ? `char-chat-${activeCharacterForChat.id}` : currentMode;
                const historyForMode = chatHistory[historyKey] || [];
                chatMessages.innerHTML = '';
                if (historyForMode.length === 0) {
                    const welcomeMessages = {
                        'general-chat': '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢',
                        'promptmaster': '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ß‡∏¥‡πà‡∏á‡∏´‡∏ô‡∏µ‡∏ö‡∏ô‡∏ï‡∏∂‡∏Å‡∏£‡∏∞‡∏ü‡πâ‡∏≤‡∏ï‡∏≠‡∏ô‡∏ù‡∏ô‡∏ï‡∏Å"',
                        'novel-writer': '‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ô‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏•‡πá‡∏≠‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                        'char-chat': '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤',
                        'storyboard': '‡πÉ‡∏™‡πà‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡∏°‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏â‡∏≤‡∏Å‡πÜ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö',
                        'image': '‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏ß‡πâ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ô‡∏±‡∏Å‡∏ö‡∏¥‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏®‡∏Ç‡∏µ‡πà‡∏°‡πâ‡∏≤‡∏ö‡∏ô‡∏î‡∏≤‡∏ß‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£"',
                        'analyzer': '‡∏ß‡∏≤‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
                        'character': '‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á ‡πÄ‡∏ä‡πà‡∏ô "‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡∏´‡∏ç‡∏¥‡∏á‡πÉ‡∏ô‡∏ä‡∏∏‡∏î‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏™‡∏µ‡πÄ‡∏á‡∏¥‡∏ô"',
                        'library': '‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ "‡∏•‡∏ö" ‡πÑ‡∏î‡πâ',
                        'favorites': '‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏•‡∏±‡∏á Prompt ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢',
                        'gallery': '‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ï‡πá‡∏°'
                    };

                     let welcomeText = welcomeMessages[currentMode] || `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î '${currentMode}' ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!`;
                     if(currentMode === 'char-chat' && activeCharacterForChat) welcomeText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö ${activeCharacterForChat.nickname} ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!`;
                     
                     chatMessages.innerHTML = `<div class="message assistant"><div class="message-avatar">${(currentMode === 'char-chat' && activeCharacterForChat) ? 'üé≠' : 'ü§ñ'}</div><div class="message-content">${welcomeText}</div></div>`;
                } else {
                    historyForMode.forEach(msg => renderMessage(msg.parts[0].text, msg.role === 'model' ? 'assistant' : 'user', msg.id));
                }
                 chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function clearCurrentHistory() {
                 if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    const historyKey = (currentMode === 'char-chat' && activeCharacterForChat) ? `char-chat-${activeCharacterForChat.id}` : currentMode;
                    if (chatHistory[historyKey]) {
                        chatHistory[historyKey] = [];
                        saveChatHistory();
                    }
                }
            }
            
            const characterModal = document.getElementById('characterCreatorModal');
            function openCharacterModal(characterToEdit = null) {
                editingCharacterId = characterToEdit ? characterToEdit.id : null;
                selectedCharImageFile = null;
                
                const previewImg = document.getElementById('charImagePreviewImg');
                const previewSpan = document.getElementById('charImagePreview').querySelector('span');

                document.getElementById('charNickname').value = characterToEdit ? characterToEdit.nickname : '';
                document.getElementById('charAppearance').value = characterToEdit ? characterToEdit.appearance : '';
                document.getElementById('charPersonality').value = characterToEdit ? characterToEdit.personality : '';
                
                if (characterToEdit && characterToEdit.imageUrl) {
                    previewImg.src = characterToEdit.imageUrl;
                    previewImg.style.display = 'block';
                    previewSpan.style.display = 'none';
                } else {
                    previewImg.style.display = 'none';
                    previewImg.src = '';
                    previewSpan.style.display = 'flex';
                }

                characterModal.classList.add('show'); 
            }
            function closeCharacterModal() { characterModal.classList.remove('show'); }
            
            async function saveCharacter() {
                const nickname = document.getElementById('charNickname').value.trim();
                const appearance = document.getElementById('charAppearance').value.trim();
                const personality = document.getElementById('charPersonality').value.trim();
                if (!nickname || !appearance) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å/‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó" ‡πÅ‡∏•‡∏∞ "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å"'); return; }
                
                const saveBtn = document.getElementById('saveCharacterBtn');
                saveBtn.disabled = true;
                saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

                let imageUrl = document.getElementById('charImagePreviewImg').src;
                if(selectedCharImageFile) {
                    try {
                        const storageRef = storage.ref(`users/${userId}/characters/${Date.now()}_${selectedCharImageFile.name}`);
                        const snapshot = await storageRef.put(selectedCharImageFile);
                        imageUrl = await snapshot.ref.getDownloadURL();
                    } catch(error) {
                         console.error("Image upload failed:", error);
                         alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS ‡∏Ç‡∏≠‡∏á Firebase Storage');
                         saveBtn.disabled = false;
                         saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£';
                         return;
                    }
                }

                const characterData = { nickname, appearance, personality, imageUrl: imageUrl.startsWith('http') ? imageUrl : '', createdAt: new Date() };
                
                try {
                    if (editingCharacterId) {
                        await db.collection("users").doc(userId).collection("characters").doc(editingCharacterId).update(characterData);
                        alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    } else {
                        await db.collection("users").doc(userId).collection("characters").add(characterData);
                        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    }
                    closeCharacterModal();
                } catch (error) {
                    console.error("Error saving character: ", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£");
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£';
                }
            }
            
            async function populateCharacterDropdown() {
                const selectElement = document.getElementById('novelCharacterSelect');
                if (!selectElement) return;

                const q = db.collection("users").doc(userId).collection("characters").orderBy("createdAt", "desc");
                const querySnapshot = await q.get();

                selectElement.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';
                querySnapshot.forEach((doc) => {
                    const character = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = character.nickname;
                    selectElement.appendChild(option);
                });
            }
            
            async function loadCharacters() {
                const charListPanel = document.getElementById('characterList');
                if (!charListPanel) return;

                const q = db.collection("users").doc(userId).collection("characters").orderBy("createdAt", "desc");
                q.onSnapshot((querySnapshot) => {
                    charListPanel.innerHTML = '';
                    if (querySnapshot.empty) {
                        charListPanel.innerHTML = `<div class="tip-card"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p></div>`;
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const char = { id: doc.id, ...doc.data() };
                        const imageUrl = char.imageUrl || '[https://placehold.co/100x100/2a2a2a/a0a0a0?text=](https://placehold.co/100x100/2a2a2a/a0a0a0?text=)üé≠';
                        const charCard = document.createElement('div');
                        charCard.className = 'tip-card';
                        charCard.innerHTML = `
                        <div style="display:flex; align-items:center; gap:1rem;">
                           <img src="${imageUrl}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                           <div style="flex-grow:1;">
                                <h4>${char.nickname}</h4>
                                <p>${char.appearance.substring(0,80)}...</p>
                           </div>
                        </div>
                        <div style="margin-top: 1rem; display:flex; gap: 0.5rem;">
                           <button class="use-char-btn" data-id="${char.id}">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                           <button class="edit-char-btn" data-id="${char.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                           <button class="delete-char-btn" data-id="${char.id}" style="background-color: var(--error-color);">‡∏•‡∏ö</button>
                        </div>`;
                        charListPanel.appendChild(charCard);
                    });
                });
            }

            async function useCharacter(id) {
                 const doc = await db.collection("users").doc(userId).collection("characters").doc(id).get();
                 if(doc.exists){
                     const character = doc.data();
                     let charPrompt = `‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£: ${character.nickname}\n‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞: ${character.appearance}\n‡∏ô‡∏¥‡∏™‡∏±‡∏¢: ${character.personality}`;
                     switchMode('promptmaster');
                     setTimeout(() => { messageInput.value = charPrompt; messageInput.focus(); }, 100);
                 }
            }

            async function editCharacter(id) {
                const doc = await db.collection("users").doc(userId).collection("characters").doc(id).get();
                if (doc.exists) {
                    openCharacterModal({ id: doc.id, ...doc.data() });
                }
            }
            
            async function deleteCharacter(id) {
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    await db.collection("users").doc(userId).collection("characters").doc(id).delete();
                }
            }

            async function saveFavorite(promptText, button) {
                try {
                    await db.collection("users").doc(userId).collection("favorites").add({
                        prompt: promptText,
                        mode: currentMode,
                        createdAt: new Date()
                    });
                    button.textContent = '‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!'; button.disabled = true;
                    setTimeout(() => { button.textContent = '‚≠ê ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; button.disabled = false; }, 2000);
                } catch(e) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
                }
            }

            async function loadFavorites() {
                const favListPanel = document.getElementById('favoritesList');
                 if (!favListPanel) return;

                const q = db.collection("users").doc(userId).collection("favorites").orderBy("createdAt", "desc");
                q.onSnapshot((querySnapshot) => {
                    favListPanel.innerHTML = '';
                    if (querySnapshot.empty) {
                        favListPanel.innerHTML = `<div class="tip-card"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Prompt ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p></div>`;
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const fav = { id: doc.id, ...doc.data() };
                        const favCard = document.createElement('div');
                        favCard.className = 'tip-card';
                        favCard.innerHTML = `<h4>[${fav.mode}]</h4><p>${fav.prompt.substring(0,150)}...</p><div style="margin-top: 1rem; display:flex; gap: 0.5rem;"><button class="use-fav-btn" data-id="${fav.id}">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button><button class="delete-fav-btn" data-id="${fav.id}" style="background-color: var(--error-color);">‡∏•‡∏ö</button></div>`;
                        favListPanel.appendChild(favCard);
                    });
                });
            }

            async function useFavorite(id) {
                 const doc = await db.collection("users").doc(userId).collection("favorites").doc(id).get();
                 if(doc.exists){
                    const favorite = doc.data();
                    switchMode(favorite.mode);
                    setTimeout(() => { messageInput.value = favorite.prompt; messageInput.focus(); }, 100);
                 }
            }

            async function deleteFavorite(id) {
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Prompt ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    await db.collection("users").doc(userId).collection("favorites").doc(id).delete();
                }
            }

            // --- Gallery Functions ---
            async function saveImageToGallery(base64Data, prompt) {
                try {
                    const blob = await (await fetch(base64Data)).blob();
                    const storageRef = storage.ref(`users/${userId}/gallery/${Date.now()}.png`);
                    const snapshot = await storageRef.put(blob);
                    const imageUrl = await snapshot.ref.getDownloadURL();

                    await db.collection("users").doc(userId).collection("gallery").add({
                        imageUrl: imageUrl,
                        prompt: prompt,
                        createdAt: new Date()
                    });

                } catch (error) {
                    console.error("Error saving image:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û");
                }
            }
            
            async function loadGallery() {
                const galleryGrid = document.getElementById('gallery-grid');
                if (!galleryGrid) return;
                
                const q = db.collection("users").doc(userId).collection("gallery").orderBy("createdAt", "desc");
                q.onSnapshot((querySnapshot) => {
                    galleryGrid.innerHTML = '';
                    if(querySnapshot.empty) {
                        galleryGrid.innerHTML = `<div class="tip-card"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p></div>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const imageData = doc.data();
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        item.innerHTML = `<img src="${imageData.imageUrl}" alt="Generated Image">`;
                        item.addEventListener('click', () => openImageViewer(imageData.imageUrl, imageData.prompt));
                        galleryGrid.appendChild(item);
                    });
                });
            }

            function openImageViewer(url, prompt) {
                const modal = document.getElementById('image-viewer-modal');
                document.getElementById('viewer-image').src = url;
                document.getElementById('viewer-prompt').textContent = prompt;
                modal.classList.add('show');
            }

            function closeImageViewer() {
                document.getElementById('image-viewer-modal').classList.remove('show');
            }


            // --- Event Listeners ---
            modeButtons.forEach(btn => btn.addEventListener('click', () => {
                switchMode(btn.dataset.mode)
                if(window.innerWidth <= 1024) toggleMenu();
            }));
            
            mobileMenuBtn.addEventListener('click', toggleMenu);
            backdrop.addEventListener('click', toggleMenu);

            function toggleMenu() {
                sidePanelContainer.classList.toggle('show');
                backdrop.classList.toggle('show');
            }

            sendButton.addEventListener('click', sendMessage);
            ideaBtn.addEventListener('click', suggestIdea);
            messageInput.addEventListener('keydown', (e) => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            clearHistoryBtn.addEventListener('click', clearCurrentHistory);
            logoutBtn.addEventListener('click', () => auth.signOut());
            
            characterModal.querySelector('.close-btn').addEventListener('click', closeCharacterModal);
            characterModal.addEventListener('click', (e) => { if (e.target === characterModal) closeCharacterModal(); });
            
            const charImageUpload = document.getElementById('charImageUpload');
            const charImagePreview = document.getElementById('charImagePreview');
            const charImagePreviewImg = document.getElementById('charImagePreviewImg');

            charImagePreview.addEventListener('click', () => charImageUpload.click());
            charImageUpload.addEventListener('change', (e) => {
                if(e.target.files && e.target.files[0]) {
                    selectedCharImageFile = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        charImagePreviewImg.src = event.target.result;
                        charImagePreviewImg.style.display = 'block';
                        charImagePreview.querySelector('span').style.display = 'none';
                    }
                    reader.readAsDataURL(selectedCharImageFile);
                }
            });

            document.getElementById('saveCharacterBtn').addEventListener('click', saveCharacter);
            
            loginForm.toggleLink.addEventListener('click', (e) => {
                e.preventDefault();
                isLoginMode = !isLoginMode;
                loginForm.errorDiv.style.display = 'none';
                if (isLoginMode) {
                    loginForm.title.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                    loginForm.submitBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                    loginForm.promptText.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?';
                    loginForm.toggleLink.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                } else {
                    loginForm.title.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                    loginForm.submitBtn.textContent = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                    loginForm.promptText.textContent = '‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß?';
                    loginForm.toggleLink.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                }
            });

            loginForm.submitBtn.addEventListener('click', async () => {
                const email = loginForm.emailInput.value;
                const password = loginForm.passwordInput.value;
                loginForm.errorDiv.style.display = 'none';

                if (!email || !password) {
                    loginForm.errorDiv.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                    loginForm.errorDiv.style.display = 'block';
                    return;
                }

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                    }
                } catch (error) {
                    console.error("Auth error:", error.code, error.message);
                    let message = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
                    switch (error.code) {
                        case 'auth/wrong-password':
                            message = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                            break;
                        case 'auth/user-not-found':
                            message = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ';
                            break;
                        case 'auth/email-already-in-use':
                            message = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                            break;
                        case 'auth/weak-password':
                            message = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
                            break;
                    }
                    loginForm.errorDiv.textContent = message;
                    loginForm.errorDiv.style.display = 'block';
                }
            });

            sidePanelContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('use-char-btn')) useCharacter(e.target.dataset.id);
                if (e.target.classList.contains('edit-char-btn')) editCharacter(e.target.dataset.id);
                if (e.target.classList.contains('delete-char-btn')) deleteCharacter(e.target.dataset.id);
                if (e.target.classList.contains('use-fav-btn')) useFavorite(e.target.dataset.id);
                if (e.target.classList.contains('delete-fav-btn')) deleteFavorite(e.target.dataset.id);
            });
            
            chatMessages.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.classList.contains('action-btn')) return;
                const promptText = decodeURIComponent(target.dataset.prompt || '');
                if (target.classList.contains('copy-btn')) {
                    navigator.clipboard.writeText(promptText).then(() => { target.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!'; setTimeout(() => target.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 2000); });
                }
                if (target.classList.contains('favorite-btn')) { saveFavorite(promptText, target); }
                if (target.classList.contains('generate-image-btn')) {
                    const negativePrompt = document.getElementById('negativePromptInput')?.value.trim() || '';
                    const finalPrompt = promptText + (negativePrompt ? ` --no ${negativePrompt}` : '');
                    const messageContentDiv = target.closest('.message-content');
                    target.closest('.message-actions').remove();
                    const placeholder = document.createElement('div');
                    placeholder.className = 'image-loading-placeholder';
                    placeholder.innerHTML = `<div class="image-loading-spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û...</p>`;
                    messageContentDiv.appendChild(placeholder);
                    callImagenAPI(finalPrompt, messageContentDiv);
                }
            });

            const imageViewerModal = document.getElementById('image-viewer-modal');
            imageViewerModal.addEventListener('click', (e) => {
                if (e.target === imageViewerModal || e.target.classList.contains('close-btn')) {
                    closeImageViewer();
                }
            });


            // --- Initial Load ---
            initializeFirebase();
        });
    </script>
</body>
</html>

